<html>
    <script>
        user = null;
        async function getUser(){
            try{
            //Get User Object from server
                let userRequest = new Request("api/User", {
                    method: "GET"
                });
                response = await fetch(userRequest);
                return await response.json();
            } catch (error) {
                console.error("ERROR:", error);
            }
            return null;
        }
        async function getChannel(user){
            try{
                //Get Channel Object from server
                channel_id = parseInt(location.search.split('channel_id=')[1]);
                let channelRequest = new Request("api/Channel?id=" + channel_id, {
                    method: "GET"
                });
                response = await fetch(channelRequest);
                return await response.json();                
            } catch (error) {
                console.error("ERROR:", error);
            }
            return null;
        }
        async function getMessages(channel){
            try{
            //Get Messages list from server
                let messagesRequest = new Request("api/GroupMessage?channel_id=" + channel.id, {
                    method: "GET"
                });
                response = await fetch(messagesRequest);
                messages = await response.json();
                if(messages.list != null) return messages.list;
                else return [messages];
            } catch (error) {
                console.error("ERROR:", error);
            }
            return null;
        }
        async function load(){
            channel = await getChannel();
            if(channel == null) return;
            document.getElementById("Heading").innerHTML = channel.channel_name;

            user = await getUser(); 
            if(user == null) return;

            messages = await getMessages(channel);
            if(messages == null) return;
            for(let i = 0; i < messages.length; i++){
                let message = messages[i];
                
                let h3 = document.createElement("h3");
                h3.innerHTML = message.sender_id;
                document.getElementById("messages").appendChild(h3);

                let div = document.createElement("div");
                div.innerHTML = message.message_text;
                document.getElementById("messages").appendChild(div);
            }            
        }
        async function submitMessage(){
            event.preventDefault();
            try{
                sender_id = user.id;
                channel_id = parseInt(location.search.split('channel_id=')[1]);
                message_text = document.getElementById("message").value;
                //Break the message into 2000 character chunks
                while(message_text.length > 0){
                    let messageRequest = new Request("api/GroupMessage", {
                        method: "POST",
                        body: "sender_id=" + sender_id + "&channel_id=" + channel_id + "&message_text=" + message_text.substring(0, 2000)
                    });
                    console.log(messageRequest);
                    console.log(message_text.substring(0, 2000));
                    response = await fetch(messageRequest);
                    message_text = message_text.substring(2000);
                }
                location.reload();
            }
            catch(error){
                console.error("ERROR:", error);
            }
        }
    </script>
    <body onload = "load()">
        <h1 id = "Heading"></h1>
        <h2>Messages</h2>
        <div id = "messages" style="list-style-type: none;">
        </div>
        <form method="post" name="Message" action="api/GroupMessage">
            <label for="message">Message:</label>
            <input type="text" id="message" name="message_text" required><br>
            <input type="submit" onclick="return submitMessage()">
        </form>
    </body>
</html>